<!DOCTYPE html>
<html>
<head>
  <title>OnTimer</title>
    <link href="js/bootstrap.css" rel="stylesheet">
    <link href="js/bootstrap-responsive.css" rel="stylesheet">
	<link href="js/prettify.css" rel="stylesheet">
	<script src="slinck.js"></script>
	<script src="js/jquery-1.7.2.min.js"></script>
	<script src='js/json2html.js' type='text/javascript'></script>
	<script src='js/jquery.json2html.js' type='text/javascript'></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="d3/d3.min.js"></script>

<style type="text/css">
	table.gridtable {
		font-family: verdana,arial,sans-serif;
		font-size:11px;
		color:#333333;
		border-width: 1px;
		border-color: #666666;
		border-collapse: collapse;
	}
	table.gridtable thead tr th {
		border-width: 1px;
		padding: 2px;
		border-style: solid;
		border-color: #666666;
		background-color: #dedede;
	}
	table.gridtable tbody tr td {
		border-width: 1px;
		padding: 2px;
		border-style: solid;
		border-color: #666666;
	}
	table.gridtable tbody tr th {
		border-width: 1px;
		text-align: left;
		padding: 2px;
		border-style: solid;
		border-color: #666666;
		background-color: #dedede;
	}

	#page {min-height:600px;}
	.package {margin-left:10px;padding:3px;border-radius:2px;margin-top:2px;}
	.header {cursor:pointer;}

	.name {color:gray;}

	.array {background-color:#FFD8BB;border:thin solid #FFB780;}
	.object {background-color:#E7F1FE;border:thin solid #7DA2CE;}
	.string {color:red;}
	.number {color:blue;}
	.function {color:green;}

	.open .children {display:block;}
	.closed .children {display:none;}
	
	.arrow {background-image:url("img/d.png"); background-repeat:no-repeat; background-color:transparent; height:15px; width:15px; display:inline-block;}

	.open .arrow {background-position:-20px 0;}
	.closed .arrow {background-position:0 0;}

	.type {color:gray;font-size:8pt;float:right;}

	.hide {display:none;}

	#main {width:100%;height:500px;overflow-y:scroll;}
</style>
</head>
<body>
  <div class="container" id="page">
    <h1>ontimer</h1>
    <hr>
      WebSocket status : <span id="message"></span>
    <hr>
    <h3>Events</h3>
      <div id="data_container" >
      </div>
      <div id="debug" >
      </div>
  </div>
  <script>
    $(function(){

    var globals = {selection:{}};
    function process_known_content(json){
      if(json.get_event_tasks){
        globals.events={}
        globals.tasks={}
        json.get_event_tasks.forEach(function(ev){
          globals.events[ev.event_id]=ev;
          ev.tasks.forEach(function(t){
            globals.tasks[t.event_task_id]=t;
          })
        });
        for ( var key in globals.selection) {
          if ( globals.selection.hasOwnProperty(key) && !globals.tasks.hasOwnProperty(key) ){
			delete globals.selection[key];             
          } 
        } 
        globals.get_event_tasks=json.get_event_tasks
        update_event_table(json.get_event_tasks)
		return true;
      }
      if(json.meta){
        globals.meta = json.meta;
        globals.EventStatus = $_.utils.BiMap(globals.meta.EventStatus)
        globals.TaskStatus = $_.utils.BiMap(globals.meta.TaskStatus)
        return true;
      }
      return false;
    }
    
    var table = d3.select("#data_container").append("table").attr('class','gridtable');
    thead = table.append("thead");
	thead_tr = thead.append("tr");
	
    function update_event_table(events){
	     var column_names = ['id', 'name',  'scheduled', 'status', 'run_count', 'updated', 'depend_on'];
	     
	     var event_group_header =  function(d){
         	return [ 
   	             $_.TCell(d, 'event_string', 2), 
   	             $_.TCell(d, 'started_dt',   1,$_.utils.relativeDateString), 
   	             $_.TCell(d, 'event_status',  1, globals.EventStatus.key )  , 
   	             $_.TCell(d, undefined,      3) ]; 
         };
       	
	     var cells_data = function(d){
	        return [  
                 $_.TCell(d, 'event_task_id', 1), 
   	             $_.TCell(d, 'task_name', 1), 
   	             $_.TCell(d, 'run_at_dt', 1 , $_.utils.relativeDateString), 
   	             $_.TCell(d, 'task_status', 1, globals.TaskStatus.key), 
   	             $_.TCell(d, 'run_count', 1 ), 
   	             $_.TCell(d, 'updated_dt', 1, $_.utils.relativeDateString), 
   	             $_.TCell(d, 'depend_on', 1)  ]; 
	     };
	     
	     
	     ths = thead_tr.selectAll("th").data(column_names);
	     ths.enter().append("th").text(function(column) { return column; });
	     ths.exit().remove();

	     tbody = table.selectAll("tbody").data(events,function(d,i){return i +':' + d['event_id'];});
	     
	     tbody.enter().append("tbody").append("tr").attr("class","event_row")
	     tbody.exit().remove();
	     
	     event_group_ths = tbody.select(".event_row").selectAll("th").data( event_group_header);
	     event_group_ths.enter().append('th').attr('colspan',function(d){return d.colspan});
	     event_group_ths.text(function(d){return d.content();});
	     
	     // append the header row
	     
	     // create a row for each object in the data
	     var rows = tbody.selectAll(".task_row").data(function(d){return d.tasks;}, function(d){return d['event_task_id'];} );
	     rows.enter().append("tr").attr("class","task_row").on("click",task_click);
	     rows.style('background-color',function(t) { return globals.selection[t.event_task_id] ?  "#ffffaa" : "#ffffff" ; });
		 rows.exit().remove();
		 
    	    
		 function task_click(t){
		   if(globals.selection[t.event_task_id]){
		     delete globals.selection[t.event_task_id];
		   }else{
		     globals.selection[t.event_task_id] = true;
		   }
		   update_event_table(globals.get_event_tasks);
		 }
		 
		 // create a cell in each row for each column
	     var cells = rows.selectAll("td").data( cells_data );
	     cells.enter().append("td");
	     cells.text(function(d) { return d.content(); });
	     cells.exit().remove();    
    }


    var $container = $('#debug');
    var ws = new WebSocket('ws://localhost:9753/ws');
    var $message = $('#message');
    ws.onopen = function(){
      $message.attr("class", 'label label-success');
      $message.text('open');
    };
    ws.onmessage = function(ev){
      $message.attr("class", 'label label-info');
      $message.hide();
      $message.fadeIn("slow");
      $message.text('recieved message');
      setTimeout(function(){$message.text('open') }, 2000)
      
      var json = JSON.parse(ev.data)
	  
      if(!process_known_content(json)){
        // content is unknown just output json
        visualize(json)
      }
    };
    setInterval(function() {
      if( globals.get_event_tasks ) 
        update_event_table(globals.get_event_tasks)
    }, 1000 * 60 ); 
    ws.onclose = function(ev){
      $message.attr("class", 'label label-important');
      $message.text('closed');
    };
    ws.onerror = function(ev){
      $message.attr("class", 'label label-warning');
      $message.text('error occurred');
    };
    var transforms = {
    		'object':{'tag':'div','class':'package ${show} ${type}','children':[
    			{'tag':'div','class':'header','children':[
    				{'tag':'div','class':function(obj){
    					if( getValue(obj.value) !== undefined ) return('arrow hide');
    					else return('arrow');
    				}},
    				{'tag':'span','class':'name','html':'${name}'},
    				{'tag':'span','class':'value','html':function(obj) {
    					var value = getValue(obj.value);
    					if( value !== undefined ) return(" : " + value);
    					else return('');
    				}},
    				{'tag':'span','class':'type','html':'${type}'}
    			]},
    			{'tag':'div','class':'children','children':function(obj){return(children(obj.value));}}
    		]}
    	};

   	function visualize(json) {
   		$container.html('');
   		var converted = convert('json',json,'open');
   		$container.json2html(converted,transforms.object);
   		regEvents();		
   	}

    	function getValue(obj) {
    		var type = $.type(obj);

    		//Determine if this object has children
    		switch(type) {
    			case 'array':
    			case 'object':
    				return(undefined);
    			break;

    			case 'function':
    				//none
    				return('function');
    			break;

    			case 'string':
    				return("'" + obj + "'");
    			break;

    			default:
    				return(obj);
    			break;
    		}
    	}

    	//Transform the children
    	function children(obj){
    		var type = $.type(obj);

    		//Determine if this object has children
    		switch(type) {
    			case 'array':
    			case 'object':
    				return(json2html.transform(obj,transforms.object));
    			break;

    			default:
    				//This must be a litteral
    			break;
    		}
    	}

    	function convert(name,obj,show) {
    		
    		var type = $.type(obj);

    		if(show === undefined) show = 'closed';
    		
    		var children = [];

    		//Determine the type of this object
    		switch(type) {
    			case 'array':
    				//Transform array
    				//Itterrate through the array and add it to the elements array
    				var len=obj.length;
    				for(var j=0;j<len;++j){	
    					//Concat the return elements from this objects tranformation
    					children[j] = convert(j,obj[j]);
    				}
    			break;

    			case 'object':
    				//Transform Object
    				var j = 0;
    				for(var prop in obj) {
    					children[j] = convert(prop,obj[prop]);
    					j++;
    				}	
    			break;

    			default:
    				//This must be a litteral (or function)
    				children = obj;
    			break;
    		}

    		return( {'name':name,'value':children,'type':type,'show':show} );
    		
    	}

    	function regEvents() {

    		$('.header').click(function(){
    			var parent = $(this).parent();

    			if(parent.hasClass('closed')) {
    				parent.removeClass('closed');
    				parent.addClass('open');
    			} else {
    				parent.removeClass('open');
    				parent.addClass('closed');
    			}		
    		});
    	}
    });

  </script>
</body>
</html>
